<!DOCTYPE html>

<html>
<head>
  <title>Chip Routing</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="chip-routing">Chip Routing</h1>
<p>Work inspired by and in some cases based off of work done for Express.js (<a href="https://github.com/visionmedia/express">https://github.com/visionmedia/express</a>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Router</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Events: error, change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@routes</span> = []
    <span class="hljs-property">@params</span> = {}
    <span class="hljs-property">@paramsExp</span> = {}
    <span class="hljs-property">@prefix</span> = <span class="hljs-string">''</span>
    makeEventEmitter <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Registers a <code>callback</code> function to be called when the given param <code>name</code> is matched in a URL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">param</span>: <span class="hljs-function"><span class="hljs-params">(name, callback)</span> -&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">or</span> callback <span class="hljs-keyword">instanceof</span> RegExp
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'param must have a callback of type "function" or RegExp. Got '</span> + callback + <span class="hljs-string">'.'</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      (<span class="hljs-property">@params</span>[name] <span class="hljs-keyword">or</span> <span class="hljs-property">@params</span>[name] = []).push(callback)
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@paramsExp</span>[name] = callback
    <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Registers a <code>callback</code> function to be called when the given path matches a URL. The callback receives two
arguments, <code>req</code>, and <code>next</code>, where <code>req</code> represents the request and has the properties, <code>url</code>, <code>path</code>, <code>params</code>
and <code>query</code>. <code>req.params</code> is an object with the parameters from the path (e.g. /:username/<em> would make a params
object with two properties, <code>username</code> and `</em><code>).</code>req.query` is an object with key-value pairs from the query
portion of the URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">route</span>: <span class="hljs-function"><span class="hljs-params">(path, callback)</span> -&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> callback <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'route must have a callback of type "function". Got '</span> + callback + <span class="hljs-string">'.'</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> path <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      path = <span class="hljs-string">'/'</span> + path
      path = path.replace <span class="hljs-regexp">/\/{2,}/g</span>, <span class="hljs-string">'/'</span>
    <span class="hljs-property">@routes</span>.push <span class="hljs-keyword">new</span> Route path, callback
    <span class="hljs-keyword">this</span>
  
  
  <span class="hljs-attribute">redirect</span>: <span class="hljs-function"><span class="hljs-params">(url, replace = <span class="hljs-literal">false</span>)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> url.charAt(<span class="hljs-number">0</span>) <span class="hljs-keyword">is</span> <span class="hljs-string">'.'</span> <span class="hljs-keyword">or</span> url.split(<span class="hljs-string">'//'</span>).length &gt; <span class="hljs-number">1</span>
      pathParts = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'a'</span>)
      pathParts.href = url
      url = pathname(pathParts) + pathParts.search
    <span class="hljs-keyword">else</span>
      url = <span class="hljs-property">@prefix</span> + url
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@currentUrl</span> <span class="hljs-keyword">is</span> url</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Redirects if the url isnâ€™t at this page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@hashOnly</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@root</span> <span class="hljs-keyword">and</span> url.indexOf(<span class="hljs-property">@root</span>) <span class="hljs-keyword">isnt</span> <span class="hljs-number">0</span>
      location.href = url
      <span class="hljs-keyword">return</span>
    
    notFound = <span class="hljs-literal">false</span>
    <span class="hljs-property">@on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(errHandler = (err) -&gt;
      notFound = <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> err <span class="hljs-keyword">is</span> <span class="hljs-string">'notFound'</span>
    )</span>
    
    if @usePushState
      if replace
        history.replaceState {}, '', url
      else
        history.pushState {}, '', url
      @currentUrl = url
      @dispatch url
    else
      if not @hashOnly
        url = url.replace @root, ''
        url = '/' + url if url.charAt<span class="hljs-params">(<span class="hljs-number">0</span>)</span> isnt '/'
      location.hash = if url is '/' then '' else '#' + url
    
    @off 'error', errHandler
    return not notFound
  
  
  listen: <span class="hljs-params">(options = {})</span> -&gt;</span>
    <span class="hljs-keyword">if</span> options.stop
      $(<span class="hljs-built_in">window</span>).<span class="hljs-literal">off</span> <span class="hljs-string">'popstate hashChange'</span>, <span class="hljs-property">@_handleChange</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@_handleChange</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    
    <span class="hljs-property">@root</span> = options.root <span class="hljs-keyword">if</span> options.root?
    <span class="hljs-property">@prefix</span> = options.prefix <span class="hljs-keyword">if</span> options.prefix?
    <span class="hljs-property">@hashOnly</span> = options.hashOnly <span class="hljs-keyword">if</span> options.hashOnly?
    <span class="hljs-property">@usePushState</span> = <span class="hljs-keyword">not</span> <span class="hljs-property">@hashOnly</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">window</span>.history?.pushState?
    <span class="hljs-property">@hashOnly</span> = <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@root</span>? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@usePushState</span>
    <span class="hljs-property">@prefix</span> = <span class="hljs-string">''</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@hashOnly</span>
    getUrl = <span class="hljs-literal">null</span>
    
    <span class="hljs-property">@_handleChange</span> = <span class="hljs-function">=&gt;</span>
      url = getUrl()
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@currentUrl</span> <span class="hljs-keyword">is</span> url
      <span class="hljs-property">@currentUrl</span> = url
      <span class="hljs-property">@dispatch</span> url
    
    <span class="hljs-keyword">if</span> <span class="hljs-property">@usePushState</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Fix the URL if linked with a hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> location.hash
        url = location.pathname.replace(<span class="hljs-regexp">/\/$/</span>, <span class="hljs-string">''</span>) + location.hash.replace <span class="hljs-regexp">/^#?\/?/</span>, <span class="hljs-string">'/'</span>
        history.replaceState({}, <span class="hljs-string">''</span>, url)
<span class="hljs-function">      
      <span class="hljs-title">getUrl</span> = -&gt;</span> location.pathname + location.search
      $(<span class="hljs-built_in">window</span>).<span class="hljs-literal">on</span> <span class="hljs-string">'popstate'</span>, <span class="hljs-property">@_handleChange</span>
    <span class="hljs-keyword">else</span>
<span class="hljs-function">      <span class="hljs-title">getUrl</span> = =&gt;</span>
        <span class="hljs-keyword">if</span> location.hash
          location.hash.replace(<span class="hljs-regexp">/^#\/?/</span>, <span class="hljs-string">'/'</span>)
        <span class="hljs-keyword">else</span>
          location.pathname + location.search
      $(<span class="hljs-built_in">window</span>).<span class="hljs-literal">on</span> <span class="hljs-string">'hashchange'</span>, <span class="hljs-property">@_handleChange</span>
    
    <span class="hljs-property">@_handleChange</span>()
    <span class="hljs-keyword">this</span>


  <span class="hljs-attribute">getUrlParts</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
    urlParts = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'a'</span>)
    urlParts.href = url
    path = pathname(urlParts)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> path.indexOf(<span class="hljs-property">@prefix</span>) <span class="hljs-keyword">isnt</span> <span class="hljs-number">0</span>
    path = path.replace <span class="hljs-property">@prefix</span>, <span class="hljs-string">''</span>
    path = <span class="hljs-string">'/'</span> + path <span class="hljs-keyword">if</span> path.charAt(<span class="hljs-number">0</span>) <span class="hljs-keyword">isnt</span> <span class="hljs-string">'/'</span>
    <span class="hljs-attribute">path</span>: path, <span class="hljs-attribute">query</span>: urlParts.search


  <span class="hljs-attribute">getRoutesMatchingPath</span>: <span class="hljs-function"><span class="hljs-params">(path)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> [] <span class="hljs-keyword">unless</span> path?
    <span class="hljs-property">@routes</span>.filter (route) =&gt;
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> route.match(path)
      <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> route.params
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@paramsExp</span>[key]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@paramsExp</span>[key].test value
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Dispatches all callbacks which match the <code>url</code>. <code>url</code> should be the full pathname of the location and should not
be used by your application. Use <code>redirect()</code> instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">dispatch</span>: <span class="hljs-function"><span class="hljs-params">(url)</span> -&gt;</span>
    urlParts = <span class="hljs-property">@getUrlParts</span>(url)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> urlParts
    path = urlParts.path
    req = <span class="hljs-attribute">url</span>: url, <span class="hljs-attribute">path</span>: path, <span class="hljs-attribute">query</span>: parseQuery(urlParts.query)
    <span class="hljs-property">@trigger</span> <span class="hljs-string">'change'</span>, [path]

    routes = <span class="hljs-property">@getRoutesMatchingPath</span>(path)
    callbacks = []
    
    routes.forEach (route) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>set the params on the req object first</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      callbacks.push (req, next) -&gt;
        req.params = route.params
        next()
      
      <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> route.params
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@params</span>[key]
        callbacks.push <span class="hljs-property">@params</span>[key]...
      
      callbacks.push route.callback</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Calls each callback one by one until either there is an error or we call all of them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">next</span> = <span class="hljs-params">(err)</span> =&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-property">@trigger</span>(<span class="hljs-string">'error'</span>, [err]) <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> next(<span class="hljs-string">'notFound'</span>) <span class="hljs-keyword">if</span> callbacks.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
      callback = callbacks.shift()
      callback(req, next)
    
    <span class="hljs-keyword">if</span> callbacks.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
      next(<span class="hljs-string">'notFound'</span>)
    <span class="hljs-keyword">else</span>
      next()
    <span class="hljs-keyword">this</span>
        

chip.Router = Router</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Defines a central routing object which handles all URL changes and routes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Route</span></span>
  
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(path, callback)</span> -&gt;</span>
    <span class="hljs-property">@path</span> = path
    <span class="hljs-property">@callback</span> = callback
    <span class="hljs-property">@keys</span> = []
    <span class="hljs-property">@expr</span> = parsePath path, <span class="hljs-property">@keys</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Determines whether route matches path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">match</span>: <span class="hljs-function"><span class="hljs-params">(path)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> (match = <span class="hljs-property">@expr</span>.exec path)
    <span class="hljs-property">@params</span> = {}
    
    <span class="hljs-keyword">for</span> value, i <span class="hljs-keyword">in</span> match
      <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> i <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
      key = <span class="hljs-property">@keys</span>[i - <span class="hljs-number">1</span>]
      value = decodeURIComponent(value) <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      key = <span class="hljs-string">'*'</span> <span class="hljs-keyword">unless</span> key
      <span class="hljs-property">@params</span>[key] = value
      
    <span class="hljs-literal">true</span>
  

chip.Route = Route</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Normalizes the given path string, returning a regular expression.</p>
<p>An empty array should be passed, which will contain the placeholder key names. For example <code>&quot;/user/:id&quot;</code> will then
contain <code>[&quot;id&quot;]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">parsePath</span> = <span class="hljs-params">(path, keys)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> path <span class="hljs-keyword">if</span> path <span class="hljs-keyword">instanceof</span> RegExp
  path = <span class="hljs-string">'('</span> + path.join(<span class="hljs-string">'|'</span>) + <span class="hljs-string">')'</span> <span class="hljs-keyword">if</span> Array.isArray path
  
  path = path
    .concat(<span class="hljs-string">'/?'</span>)
    .replace(<span class="hljs-regexp">/\/\(/g</span>, <span class="hljs-string">'(?:/'</span>)
    .replace(<span class="hljs-regexp">/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g</span>, <span class="hljs-function"><span class="hljs-params">(_, slash, format, key, capture, optional, star)</span> -&gt;</span>
      keys.push key
      slash = slash <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
      expr = <span class="hljs-string">''</span>
      expr += slash <span class="hljs-keyword">unless</span> optional
      expr += <span class="hljs-string">'(?:'</span>
      expr += slash <span class="hljs-keyword">if</span> optional
      expr += format <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
      expr += capture <span class="hljs-keyword">or</span> (format <span class="hljs-keyword">and</span> <span class="hljs-string">'([^/.]+?)'</span> <span class="hljs-keyword">or</span> <span class="hljs-string">'([^/]+?)'</span>) + <span class="hljs-string">')'</span>
      expr += optional <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>
      expr += <span class="hljs-string">'(/*)?'</span> <span class="hljs-keyword">if</span> star
      expr
    )
    .replace(<span class="hljs-regexp">/([\/.])/g</span>, <span class="hljs-string">'\\$1'</span>)
    .replace(<span class="hljs-regexp">/\*/g</span>, <span class="hljs-string">'(.*)'</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RegExp(<span class="hljs-string">'^'</span> + path + <span class="hljs-string">'$'</span>, <span class="hljs-string">'i'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Parses a location.search string into an object with key-value pairs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">parseQuery</span> = <span class="hljs-params">(search)</span> -&gt;</span>
  query = {}
  <span class="hljs-keyword">return</span> query <span class="hljs-keyword">if</span> search <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>
  
  search.replace(<span class="hljs-regexp">/^\?/</span>, <span class="hljs-string">''</span>).split(<span class="hljs-string">'&amp;'</span>).forEach (keyValue) -&gt;
    [key, value] = keyValue.split(<span class="hljs-string">'='</span>)
    query[decodeURIComponent(key)] = decodeURIComponent(value)
  
  query</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Fix IEâ€™s missing slash prefix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">pathname</span> = <span class="hljs-params">(anchor)</span> -&gt;</span>
  path = anchor.pathname
  path = <span class="hljs-string">'/'</span> + path <span class="hljs-keyword">unless</span> path.charAt(<span class="hljs-number">0</span>) <span class="hljs-keyword">is</span> <span class="hljs-string">'/'</span>
  path</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
